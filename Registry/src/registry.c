#include "pigaregmonitor.h"

NTSTATUS RegistryCallback(IN PVOID CallbackContext, 
						  IN PVOID  Argument1, 
						  IN PVOID  Argument2)
{
	NTSTATUS            			  	ntStatus; 
	PDEVICE_CONTEXT 					pContext = (PDEVICE_CONTEXT) CallbackContext;
	REG_NOTIFY_CLASS 					Action   = (REG_NOTIFY_CLASS) Argument1;
	UNICODE_STRING    				    *key = NULL;
	ULONG 								ReturnLength;	
	ANSI_STRING 						key_ansi;
	ANSI_STRING 						value_ansi;
	char 								buffer[1000];
	LARGE_INTEGER 						time;
	
	RtlZeroMemory(&buffer, sizeof(buffer));

	UNREFERENCED_PARAMETER(pContext);
	
	if( ExGetPreviousMode() == KernelMode) 	return STATUS_SUCCESS;
	
	switch (Action) 
	{
		case RegNtDeleteKey:
		{	
			PREG_DELETE_KEY_INFORMATION pInfo = (PREG_DELETE_KEY_INFORMATION) Argument2;
			__try{
					ntStatus = ObQueryNameString(pInfo->Object, (POBJECT_NAME_INFORMATION)key, 0, &ReturnLength);
					key = (PUNICODE_STRING)ExAllocatePoolWithTag(NonPagedPool, ReturnLength, 0);
					if (ntStatus == STATUS_INFO_LENGTH_MISMATCH)
					{	
						if (key)
						{
							ntStatus = ObQueryNameString(pInfo->Object, (POBJECT_NAME_INFORMATION)key, ReturnLength, &ReturnLength);
							if(NT_SUCCESS(ntStatus))
							{
								ntStatus = AddInQueue("-- BEGIN\n");
								
								sprintf_s(buffer,sizeof(buffer),"trace=%i , cpu=%i\n",trace++, KeGetCurrentProcessorNumber());
								AddInQueue(buffer);
								
								KeQuerySystemTime(&time);
								RtlZeroMemory(&buffer, sizeof(buffer));
								sprintf_s(buffer,sizeof(buffer),"timestamp=%I64d\n",time.QuadPart);
								AddInQueue(buffer);
								AddInQueue("Access : delete\n");
								
								RtlZeroMemory(&buffer, sizeof(buffer));								
								GetUnicodeName((int)PsGetCurrentProcessId());
								RtlUnicodeStringToAnsiString(&key_ansi, key, TRUE);
								sprintf_s(buffer, sizeof(buffer),"%s\n", key_ansi.Buffer);
								ntStatus = AddInQueue(buffer);
								ntStatus = AddInQueue("-- END\n");
							}
						}
						else
							return STATUS_SUCCESS;
					}
			}
			__except(EXCEPTION_EXECUTE_HANDLER)
			{
				ntStatus=GetExceptionCode();
				DbgPrint("Exception RegNtPreDeleteKey : %x\n", ntStatus);
			}
			
			ExFreePoolWithTag(key,0);
			break;
		}
		case RegNtPreCreateKeyEx:
		{
			PREG_CREATE_KEY_INFORMATION pInfo = (PREG_CREATE_KEY_INFORMATION) Argument2;
			__try{
					ntStatus = AddInQueue("-- BEGIN\n");
					
					sprintf_s(buffer,sizeof(buffer),"trace=%i , cpu=%i\n",trace++, KeGetCurrentProcessorNumber());
					AddInQueue(buffer);
					
					KeQuerySystemTime(&time);
					RtlZeroMemory(&buffer, sizeof(buffer));
					sprintf_s(buffer,sizeof(buffer),"timestamp=%I64d\n",time.QuadPart);
					AddInQueue(buffer);
					AddInQueue("Access : create\n");
					
					RtlZeroMemory(&buffer, sizeof(buffer));													
					RtlUnicodeStringToAnsiString(&key_ansi, pInfo->CompleteName, TRUE);
					sprintf_s(buffer, sizeof(buffer),"%s\n", key_ansi.Buffer);
					GetUnicodeName((int)PsGetCurrentProcessId());							
					ntStatus = AddInQueue(buffer);
					ntStatus = AddInQueue("-- END\n");
			}
			__except(EXCEPTION_EXECUTE_HANDLER)
			{
				ntStatus=GetExceptionCode();
				DbgPrint("Exception RegNtPreCreateKeyEx : %x\n", ntStatus);
			}
			break;
		}
		case RegNtSetValueKey:
		{
			PREG_SET_VALUE_KEY_INFORMATION pInfo = (PREG_SET_VALUE_KEY_INFORMATION) Argument2;
			
			__try{
				ntStatus = ObQueryNameString(pInfo->Object, (POBJECT_NAME_INFORMATION)key, 0, &ReturnLength);
				key = (PUNICODE_STRING)ExAllocatePoolWithTag(NonPagedPool, ReturnLength, 1);
				if (ntStatus == STATUS_INFO_LENGTH_MISMATCH)
				{
					if (key)
					{
						ntStatus = ObQueryNameString(pInfo->Object, (POBJECT_NAME_INFORMATION)key, ReturnLength, &ReturnLength);
						if(NT_SUCCESS(ntStatus))
						{
							ntStatus = AddInQueue("-- BEGIN\n");
							RtlUnicodeStringToAnsiString(&key_ansi, key, TRUE);
							
							sprintf_s(buffer,sizeof(buffer),"trace=%i , cpu=%i\n",trace++, KeGetCurrentProcessorNumber());
							AddInQueue(buffer);
							
							KeQuerySystemTime(&time);
							RtlZeroMemory(&buffer, sizeof(buffer));
							sprintf_s(buffer,sizeof(buffer),"timestamp=%I64d\n",time.QuadPart);
							AddInQueue(buffer);
							AddInQueue("Access : set_value_key\n");
							
							RtlZeroMemory(&buffer, sizeof(buffer));															
							sprintf_s(buffer, sizeof(buffer),"%s\n", key_ansi.Buffer);
							GetUnicodeName((int)PsGetCurrentProcessId());
							ntStatus = AddInQueue(buffer);
							RtlZeroMemory(&buffer, sizeof(buffer));
							RtlUnicodeStringToAnsiString(&value_ansi, pInfo->ValueName, TRUE);
							sprintf_s(buffer, sizeof(buffer),"%s\n", value_ansi.Buffer);
							ntStatus = AddInQueue(buffer);
							ntStatus = AddInQueue("-- END\n");
						}

					}
				}
				if(key)
					ExFreePoolWithTag(key,1);
				
			}
			__except(EXCEPTION_EXECUTE_HANDLER)
			{
				ntStatus=GetExceptionCode();
				DbgPrint("Exception RegNtSetValueKey : %x\n", ntStatus);
			}
			break;
		}

		case RegNtQueryValueKey:
		{
			PREG_QUERY_VALUE_KEY_INFORMATION pInfo = (PREG_QUERY_VALUE_KEY_INFORMATION) Argument2;
			__try
			{
				ntStatus = ObQueryNameString(pInfo->Object, (POBJECT_NAME_INFORMATION)key, 0, &ReturnLength);
				key = (PUNICODE_STRING)ExAllocatePoolWithTag(NonPagedPool, ReturnLength, 1);
				if (ntStatus == STATUS_INFO_LENGTH_MISMATCH)
				{
					if (key)
					{
						ntStatus = ObQueryNameString(pInfo->Object, (POBJECT_NAME_INFORMATION)key, ReturnLength, &ReturnLength);
						if(NT_SUCCESS(ntStatus))
						{
							ntStatus = AddInQueue("-- BEGIN\n");
							RtlUnicodeStringToAnsiString(&key_ansi, key, TRUE);
						
							sprintf_s(buffer,sizeof(buffer),"trace=%i , cpu=%i\n",trace++, KeGetCurrentProcessorNumber());
							AddInQueue(buffer);
							
							KeQuerySystemTime(&time);
							RtlZeroMemory(&buffer, sizeof(buffer));
							sprintf_s(buffer,sizeof(buffer),"timestamp=%I64d\n",time.QuadPart);
							AddInQueue(buffer);
							AddInQueue("Access : query_value_key\n");
							
							RtlZeroMemory(&buffer, sizeof(buffer));															
							GetUnicodeName((int)PsGetCurrentProcessId());
							sprintf_s(buffer, sizeof(buffer),"%s\n", key_ansi.Buffer);
							ntStatus = AddInQueue(buffer);
							switch(pInfo->KeyValueInformationClass)
							{
								case 0: {AddInQueue( "KeyValueBasicInformation\n"); break;}
								case 1: {AddInQueue("KeyValueFullInformation\n"); break;}
								case 2: {AddInQueue("KeyValuePartialInformation\n"); break;}
								case 3: {AddInQueue("KeyValueFullInformationAlign64\n"); break;}
								case 4: {AddInQueue("KeyValuePartialInformationAlign64\n"); break;}
								case 5: {AddInQueue("MaxKeyValueInfoClass\n"); break;}
								default: break;
							}
							ntStatus = AddInQueue("-- END\n");
						}						
						if(key)
							ExFreePoolWithTag(key,1);
					}
				}
			}
			__except(EXCEPTION_EXECUTE_HANDLER)
			{
				ntStatus=GetExceptionCode();
				DbgPrint("Exception : %x\n", ntStatus);
			}
			break;
		}
		
		case RegNtPreOpenKeyEx:
		{
			PREG_CREATE_KEY_INFORMATION pInfo = (PREG_CREATE_KEY_INFORMATION) Argument2;
			__try{
					ntStatus = AddInQueue("-- BEGIN\n");
										
					sprintf_s(buffer,sizeof(buffer),"trace=%i , cpu=%i\n",trace++, KeGetCurrentProcessorNumber());
					AddInQueue(buffer);
					
					KeQuerySystemTime(&time);
					RtlZeroMemory(&buffer, sizeof(buffer));
					sprintf_s(buffer,sizeof(buffer),"timestamp=%I64d\n",time.QuadPart);
					AddInQueue(buffer);
					AddInQueue("Access : open\n");
					
					RtlZeroMemory(&buffer, sizeof(buffer));								
					GetUnicodeName((int)PsGetCurrentProcessId());							
					RtlUnicodeStringToAnsiString(&key_ansi, pInfo->CompleteName, TRUE);
					sprintf_s(buffer, sizeof(buffer),"%s\n", key_ansi.Buffer);
					ntStatus = AddInQueue(buffer);
					ntStatus = AddInQueue("-- END\n");
			}
			__except(EXCEPTION_EXECUTE_HANDLER)
			{
				ntStatus=GetExceptionCode();
				DbgPrint("Exception RegNtPreCreateKeyEx : %x\n", ntStatus);
			}
			break;
		}
	default:
		break;
	}

	return STATUS_SUCCESS;
}


